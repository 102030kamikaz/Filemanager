/*
	MIT License
 @author		Jason Huck - Core Five Labs
 @author		Simon Georget <simon (at) linea21 (dot) com>
 @copyright	Authors
*/
(function(a){function I(a){var e=this.window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest;if(!e)throw Error("XMLHttpRequest not supported");e.open("HEAD",a,!1);e.send(null);return 200==e.status?!0:!1}function n(c,e){return"dir"==c["File Type"]&&"download"==e?!1:"undefined"==typeof c.Capabilities?!0:-1<a.inArray(e,c.Capabilities)}function q(c){var e=c.attr("class").replace(/ /g,"_");if(""==e)return"itemOptions";if(!a("#"+e).length){var d=a("#itemOptions").clone().attr("id",
e);c.hasClass("cap_select")||a(".select",d).remove();c.hasClass("cap_download")||a(".download",d).remove();c.hasClass("cap_rename")||a(".rename",d).remove();c.hasClass("cap_delete")||a(".delete",d).remove();a("#itemOptions").after(d)}return e}a.urlParam=function(a){return(a=RegExp("[\\?&]"+a+"=([^&#]*)").exec(window.location.href))?a[1]:0};var f,y=null;a.ajax({async:!1,url:"./scripts/filemanager.config.js",dataType:"json",cache:!1,success:function(a){y=a}});f=y;var l="connectors/"+f.options.lang+
"/filemanager."+f.options.lang,m=["select","download","rename","delete"];0!=a.urlParam("langCode")&&I("scripts/languages/"+a.urlParam("langCode")+".js")&&(f.options.culture=a.urlParam("langCode"));var e=[];a.ajax({url:"scripts/languages/"+f.options.culture+".js",async:!1,dataType:"json",success:function(a){e=a}});a.prompt.setDefaults({overlayspeed:"fast",show:"fadeIn",opacity:0.4,persistent:!1});var z=function(){var c=20;!0===f.options.searchBox&&(c+=33);c=a(window).height()-a("#uploader").height()-
c;a("#splitter, #filetree, #fileinfo, .vsplitbar").height(c)},A=function(a){return!1==f.options.showFullPath?"function"===typeof displayPathDecorator?displayPathDecorator(a):a.replace(fileRoot,"/"):a},t=function(c){"grid"==c?(a("#grid").addClass("ON"),a("#list").removeClass("ON")):(a("#list").addClass("ON"),a("#grid").removeClass("ON"))},u=function(a){var e="",e="\u0160\u0161\u0110\u0111\u017d\u017e\u010c\u010d\u0106\u0107\u00c0\u00c1\u00c2\u00c3\u00c4\u00c5\u00c6\u00c7\u00c8\u00c9\u00ca\u00cb\u00cc\u00cd\u00ce\u00cf\u00d1\u00d2\u00d3\u00d4\u00d5\u00d6\u0150\u00d8\u00d9\u00da\u00db\u00dc\u00dd\u00de\u00df\u00e0\u00e1\u00e2\u00e3\u00e4\u00e5\u00e6\u00e7\u00e8\u00e9\u00ea\u00eb\u00ec\u00ed\u00ee\u00ef\u00f0\u00f1\u00f2\u00f3\u00f4\u00f5\u00f6\u0151\u00f8\u00f9\u00fa\u00fb\u00fd\u00fd\u00fe\u00ff\u0154\u0155 '/".split(""),
d="S s Dj dj Z z C c C c A A A A A A A C E E E E I I I I N O O O O O O O U U U U Y B Ss a a a a a a a c e e e e i i i i o n o o o o o o o u u u y y b y R r _ _ ".split(" ");a=String(a);for(i=0;i<e.length;i++)a=a.replace(RegExp(e[i],"g"),d[i]);e=a.replace(/[^_a-zA-Z0-9]/g,"");return e=e.replace(/[_]+/g,"_")},B=function(a){a=parseFloat(a);for(var f=0,d=[e.bytes,e.kb,e.mb,e.gb];;){if(1024>a)return a=Math.round(100*a)/100,a+d[f];a/=1024;f+=1}},C=function(c){a("#fileinfo").html("<h1>"+c+"</h1>");a("#newfile").attr("disabled",
"disabled");a("#upload").attr("disabled","disabled");a("#newfolder").attr("disabled","disabled")},p=function(a){return 1==a.split(".").length?"":a.split(".").pop().toLowerCase()},v=function(c){a("#currentpath").val(c);a("#uploader h1").text(e.current_folder+A(c));a("#newfolder").unbind().click(function(){var c=e.default_foldername,d=e.prompt_foldername+' : <input id="fname" name="fname" type="text" value="'+c+'" />',b={};b[e.create_folder]=!0;b[e.cancel]=!1;a.prompt(d,{callback:function(b,d){if(1!=
b)return!1;var k=d.children("#fname").val();""!=k?(c=u(k),k=new Date,a.getJSON(l+"?mode=addfolder&path="+a("#currentpath").val()+"&name="+c+"&time="+k.getMilliseconds(),function(b){if(0==b.Code){var c=b.Parent,j=b.Name,d='<li class="directory collapsed"><a rel="'+c+j+'/" href="#">'+j+'</a><ul class="jqueryFileTree" style="display: block;"></ul></li>',g=a("#filetree").find('a[rel="'+c+'"]');c!=fileRoot?g.next("ul").prepend(d).prev("a").click().click():(a("#filetree > ul").prepend(d),a("#filetree").find('li a[rel="'+
c+j+'/"]').attr("class","cap_rename cap_delete").click(function(){h(c+j+"/")}).each(function(){a(this).contextMenu({menu:q(a(this))},function(b,c){var e=a(c).attr("rel");s(b,e)})}));f.options.showConfirmation&&a.prompt(e.successful_added_folder);h(b.Parent);a("#filetree").find('a[rel="'+b.Parent+'/"]').click().click()}else a.prompt(b.Error)})):a.prompt(e.no_foldername)},buttons:b})})},F=function(c){a("#fileinfo button").each(function(){0==a(this).find("span").length&&a(this).wrapInner("<span></span>")});
if(n(c,"select")){if(a("#fileinfo").find("button#select").click(function(){w(c)}).show(),window.opener||window.tinyMCEPopup)a("#preview img").attr("title",e.select),a("#preview img").click(function(){w(c)}).css("cursor","pointer")}else a("#fileinfo").find("button#select").hide();n(c,"rename")?a("#fileinfo").find("button#rename").click(function(){var e=D(c);e.length&&a("#fileinfo > h1").text(e)}).show():a("#fileinfo").find("button#rename").hide();n(c,"delete")?a("#fileinfo").find("button#delete").click(function(){E(c)&&
a("#fileinfo").html("<h1>"+e.select_from_left+"</h1>")}).show():a("#fileinfo").find("button#delete").hide();n(c,"download")?a("#fileinfo").find("button#download").click(function(){window.location=l+"?mode=download&path="+encodeURIComponent(c.Path)}).show():a("#fileinfo").find("button#download").hide()},H=function(){a("#filetree").fileTree({root:fileRoot,datafunc:J,multiFolder:!1,folderCallback:function(a){h(a)},expandedFolder:fullexpandedFolder,after:function(){a("#filetree").find("li a").each(function(){a(this).contextMenu({menu:q(a(this))},
function(c,e){var d=a(e).attr("rel");s(c,d)})});!0==f.options.searchBox&&(a("#q").liveUpdate("#filetree ul").blur(),a("#search span.q-inactive").html(e.search),a("#search a.q-reset").attr("title",e.search_reset))}},function(a){G(a)})},w=function(c){var g=!1!=f.options.relPath?relPath+c.Path.replace(fileRoot,""):relPath+c.Path;window.opener||window.tinyMCEPopup?window.tinyMCEPopup?(c=tinyMCEPopup.getWindowArg("window"),c.document.getElementById(tinyMCEPopup.getWindowArg("input")).value=g,"undefined"!=
typeof c.ImageDialog&&(c.ImageDialog.getImageData&&c.ImageDialog.getImageData(),c.ImageDialog.showPreviewImage&&c.ImageDialog.showPreviewImage(g)),tinyMCEPopup.close()):(a.urlParam("CKEditor")?window.opener.CKEDITOR.tools.callFunction(a.urlParam("CKEditorFuncNum"),g):""!=c.Properties.Width?window.opener.SetUrl(g,c.Properties.Width,c.Properties.Height):window.opener.SetUrl(g),window.close()):a.prompt(e.fck_select_integration)},D=function(c){var g="",d=e.new_filename+' : <input id="rname" name="rname" type="text" value="',
b;b=c.Filename;b=-1!=b.lastIndexOf(".")?b.substring(0,b.lastIndexOf(".")):b;var j={};j[e.rename]=!0;j[e.cancel]=!1;a.prompt(d+b+'" />',{callback:function(b,j){if(1!=b)return!1;rname=j.children("#rname").val();if(""!=rname){var d;d=rname;filename="";-1!=d.lastIndexOf(".")?(filename=u(d.substr(0,d.lastIndexOf("."))),filename+="."+d.split(".").pop()):filename=u(d);d=filename;var r=p(c.Filename);0<r.length&&(d=d+"."+r);var h=c.Path;a.ajax({type:"GET",url:l+"?mode=rename&old="+c.Path+"&new="+d,dataType:"json",
async:!1,success:function(b){if(0==b.Code){var d=b["New Path"],j=b["New Name"],k=a("#filetree").find('a[rel="'+h+'"]'),r=k.parent().parent().prev("a");k.attr("rel",d).text(j);r.click().click();k=a("#preview h1").attr("title");"undefined"!=typeof k&&k==h&&a("#preview h1").text(j);"grid"==a("#fileinfo").data("view")?(a('#fileinfo img[alt="'+h+'"]').parent().next("p").text(j),a('#fileinfo img[alt="'+h+'"]').attr("alt",d)):(a('#fileinfo td[title="'+h+'"]').text(j),a('#fileinfo td[title="'+h+'"]').attr("title",
d));a("#preview h1").html(j);c.Path=d;c.Filename=j;a("#fileinfo").find("button#rename, button#delete, button#download").unbind();F(c);f.options.showConfirmation&&a.prompt(e.successful_rename)}else a.prompt(b.Error);g=b["New Name"]}})}},buttons:j});return g},E=function(c){var g=!1,d=e.confirmation_delete,b={};b[e.yes]=!0;b[e.no]=!1;a.prompt(d,{callback:function(b){if(1!=b)return!1;b=l+"?mode=delete&path="+encodeURIComponent(c.Path);var d=c.Path.split("/").reverse().slice(1).reverse().join("/")+"/";
a.ajax({type:"GET",url:b,dataType:"json",async:!1,success:function(b){if(0==b.Code){var c=b.Path;a("#filetree").find('a[rel="'+c+'"]').parent().fadeOut("slow",function(){a(this).remove()});"grid"==a("#fileinfo").data("view")?a('#contents img[alt="'+c+'"]').parent().parent().fadeOut("slow",function(){a(this).remove()}):a("table#contents").find('td[title="'+c+'"]').parent().fadeOut("slow",function(){a(this).remove()});a("#preview").length&&h(c.substr(0,c.lastIndexOf("/")+1));b=b.Path.substring(0,b.Path.length-
1);b=b.substr(0,b.lastIndexOf("/")+1);a("#uploader h1").text(e.current_folder+A(b));g=!0;f.options.showConfirmation&&a.prompt(e.successful_delete);a("#filetree").find('a[rel="'+d+'/"]').click().click()}else g=!1,a.prompt(b.Error)}})},buttons:b});return g},x=function(c){c.lastIndexOf("/")==c.length-1?(h(c),a("#filetree").find('a[rel="'+c+'"]').click()):G(c)},s=function(c,e){a.getJSON(l+"?mode=getinfo&path="+e+"&time="+(new Date).getMilliseconds(),function(e){"grid"==a("#fileinfo").data("view")?a("#fileinfo").find('img[alt="'+
e.Path+'"]').parent():a("#fileinfo").find('td[title="'+e.Path+'"]').parent();switch(c){case "select":w(e);break;case "download":window.location=l+"?mode=download&path="+e.Path;break;case "rename":D(e);break;case "delete":E(e)}})},G=function(c){var g=c.substr(0,c.lastIndexOf("/")+1);v(g);var d;d='<div id="preview"><img /><h1></h1><dl></dl></div><form id="toolbar">';if(window.opener||window.tinyMCEPopup)d+='<button id="select" name="select" type="button" value="Select">'+e.select+"</button>";d+='<button id="download" name="download" type="button" value="Download">'+
e.download+"</button>";!0!=f.options.browseOnly&&(d+='<button id="rename" name="rename" type="button" value="Rename">'+e.rename+"</button>");!0!=f.options.browseOnly&&(d+='<button id="delete" name="delete" type="button" value="Delete">'+e.del+"</button>");d+='<button id="parentfolder">'+e.parentfolder+"</button>";a("#fileinfo").html(d+"</form>");a("#parentfolder").click(function(){h(g)});d=new Date;a.getJSON(l+"?mode=getinfo&path="+encodeURIComponent(c)+"&time="+d.getMilliseconds(),function(b){if(0==
b.Code){a("#fileinfo").find("h1").text(b.Filename).attr("title",c);a("#fileinfo").find("img").attr("src",b.Preview);var d;d=-1!=a.inArray(p(b.Filename),f.videos.videosExt)?!0:!1;d&&!0==f.videos.showVideoPlayer&&(d="<video width="+f.videos.videosPlayerWidth+" height="+f.videos.videosPlayerHeight+' src="'+b.Path+'" controls="controls">',d+='<img src="'+b.Preview+'" />',d+="</video>",a("#fileinfo img").remove(),a("#fileinfo #preview h1").before(d));d=-1!=a.inArray(p(b.Filename),f.audios.audiosExt)?!0:
!1;d&&!0==f.audios.showAudioPlayer&&(d='<audio src="'+b.Path+'" controls="controls">',d+='<img src="'+b.Preview+'" />',d+="</audio>",a("#fileinfo img").remove(),a("#fileinfo #preview h1").before(d));d="";b.Properties.Width&&""!=b.Properties.Width&&(d+="<dt>"+e.dimensions+"</dt><dd>"+b.Properties.Width+"x"+b.Properties.Height+"</dd>");b.Properties["Date Created"]&&""!=b.Properties["Date Created"]&&(d+="<dt>"+e.created+"</dt><dd>"+b.Properties["Date Created"]+"</dd>");b.Properties["Date Modified"]&&
""!=b.Properties["Date Modified"]&&(d+="<dt>"+e.modified+"</dt><dd>"+b.Properties["Date Modified"]+"</dd>");if(b.Properties.Size||0==parseInt(b.Properties.Size))d+="<dt>"+e.size+"</dt><dd>"+B(b.Properties.Size)+"</dd>";a("#fileinfo").find("dl").html(d);F(b)}else a.prompt(b.Error)})},h=function(c){v(c);a("#fileinfo").html('<img id="activity" src="images/wait30trans.gif" width="30" height="30" />');var g=new Date;c=l+"?path="+encodeURIComponent(c)+"&mode=getfolder&showThumbs="+f.options.showThumbs+
"&time="+g.getMilliseconds();a.urlParam("type")&&(c+="&type="+a.urlParam("type"));a.getJSON(c,function(d){var b="";if("-1"==d.Code)C(d.Error);else{if(d)if("grid"==a("#fileinfo").data("view")){b+='<ul id="contents" class="grid">';for(key in d){var c=d[key].Properties,f="";for(cap in m)n(d[key],m[cap])&&(f+=" cap_"+m[cap]);var g=64,h=c.Width;1<h&&h<g&&(g=h);b+='<li class="'+f+'" title="'+d[key].Path+'"><div class="clip"><img src="'+d[key].Preview+'" width="'+g+'" alt="'+d[key].Path+'" /></div><p>'+
d[key].Filename+"</p>";c.Width&&""!=c.Width&&(b+='<span class="meta dimensions">'+c.Width+"x"+c.Height+"</span>");c.Size&&""!=c.Size&&(b+='<span class="meta size">'+c.Size+"</span>");c["Date Created"]&&""!=c["Date Created"]&&(b+='<span class="meta created">'+c["Date Created"]+"</span>");c["Date Modified"]&&""!=c["Date Modified"]&&(b+='<span class="meta modified">'+c["Date Modified"]+"</span>");b+="</li>"}b+="</ul>"}else{b=b+'<table id="contents" class="list">'+('<thead><tr><th class="headerSortDown"><span>'+
e.name+"</span></th><th><span>"+e.dimensions+"</span></th><th><span>"+e.size+"</span></th><th><span>"+e.modified+"</span></th></tr></thead>");b+="<tbody>";for(key in d){g=d[key].Path;c=d[key].Properties;f="";for(cap in m)n(d[key],m[cap])&&(f+=" cap_"+m[cap]);b+='<tr class="'+f+'">';b+='<td title="'+g+'">'+d[key].Filename+"</td>";b=c.Width&&""!=c.Width?b+("<td>"+c.Width+"x"+c.Height+"</td>"):b+"<td></td>";b=c.Size&&""!=c.Size?b+('<td><abbr title="'+c.Size+'">'+B(c.Size)+"</abbr></td>"):b+"<td></td>";
b=c["Date Modified"]&&""!=c["Date Modified"]?b+("<td>"+c["Date Modified"]+"</td>"):b+"<td></td>";b+="</tr>"}b+="</tbody>";b+="</table>"}else b+="<h1>"+e.could_not_retrieve_folder+"</h1>";a("#fileinfo").html(b);"grid"==a("#fileinfo").data("view")?a("#fileinfo").find("#contents li").click(function(){var b=a(this).find("img").attr("alt");x(b)}).each(function(){a(this).contextMenu({menu:q(a(this))},function(b,c){var d=a(c).find("img").attr("alt");s(b,d)})}):(a("#fileinfo").find("td:first-child").each(function(){var b=
a(this).attr("title"),b=a("#filetree").find('a[rel="'+b+'"]').parent();a(this).css("background-image",b.css("background-image"))}),a("#fileinfo tbody tr").click(function(){var b=a("td:first-child",this).attr("title");x(b)}).each(function(){a(this).contextMenu({menu:q(a(this))},function(b,c){var d=a("td:first-child",c).attr("title");s(b,d)})}),a("#fileinfo").find("table").tablesorter({textExtraction:function(b){return a(b).find("abbr").size()?a(b).find("abbr").attr("title"):b.innerHTML}}))}})},J=function(c,
g){var d=new Date,d=l+"?path="+encodeURIComponent(c)+"&mode=getfolder&showThumbs="+f.options.showThumbs+"&time="+d.getMilliseconds();a.urlParam("type")&&(d+="&type="+a.urlParam("type"));a.getJSON(d,function(a){var c="";if("-1"==a.Code)C(a.Error);else{if(a){c+='<ul class="jqueryFileTree" style="display: none;">';for(key in a){var d="";for(cap in m)n(a[key],m[cap])&&(d+=" cap_"+m[cap]);c="dir"==a[key]["File Type"]?c+('<li class="directory collapsed"><a href="#" class="'+d+'" rel="'+a[key].Path+'">'+
a[key].Filename+"</a></li>"):c+('<li class="file ext_'+a[key]["File Type"].toLowerCase()+'"><a href="#" class="'+d+'" rel="'+a[key].Path+'">'+a[key].Filename+"</a></li>")}c+="</ul>"}else c+="<h1>"+e.could_not_retrieve_folder+"</h1>";g(c)}})};a(function(){if(f.extras.extra_js)for(var c=0;c<f.extras.extra_js.length;c++)a.ajax({url:f.extras.extra_js[c],dataType:"script",async:f.extras.extra_js_async});fileRoot=f.options.fileRoot?f.options.serverRoot?"/"+f.options.fileRoot:f.options.fileRoot:"/"+document.location.pathname.substring(1,
document.location.pathname.lastIndexOf("/")+1)+"userfiles/";relPath=f.options.relPath?f.options.relPath:window.location.protocol+"//"+window.location.host;0!=a.urlParam("expandedFolder")?(expandedFolder=a.urlParam("expandedFolder"),fullexpandedFolder=fileRoot+expandedFolder):(expandedFolder="",fullexpandedFolder=null);z();a(window).resize(z);!0==f.options.autoload&&(a("#upload").append(e.upload),a("#newfolder").append(e.new_folder),a("#grid").attr("title",e.grid_view),a("#list").attr("title",e.list_view),
a("#fileinfo h1").append(e.select_from_left),a('#itemOptions a[href$="#select"]').append(e.select),a('#itemOptions a[href$="#download"]').append(e.download),a('#itemOptions a[href$="#rename"]').append(e.rename),a('#itemOptions a[href$="#delete"]').append(e.del));a("#browse").append("+");a("#browse").attr("title",e.browse);a("#newfile").change(function(){a("#filepath").val(a(this).val())});!0===f.options.searchBox?a.getScript("./scripts/filemanager.liveSearch.min.js"):a("#search").remove();a("#splitter").splitter({sizeLeft:200});
a("button").wrapInner("<span></span>");a("#fileinfo").data("view",f.options.defaultViewMode);t(f.options.defaultViewMode);a("#home").click(function(){var c=a("#fileinfo").data("view");a("#fileinfo").data("view",c);a("#filetree>ul>li.expanded>a").trigger("click");h(fileRoot)});a("#grid").click(function(){t("grid");a("#fileinfo").data("view","grid");h(a("#currentpath").val())});a("#list").click(function(){t("list");a("#fileinfo").data("view","list");h(a("#currentpath").val())});v(fileRoot);a("#uploader").attr("action",
l);a("#uploader").ajaxForm({target:"#uploadresponse",beforeSubmit:function(c,d){if(""==a("#newfile",d).val())return!1;var b;b=a("#newfile",d).val();b="DISALLOW_ALL"==f.security.uploadPolicy&&-1!=a.inArray(p(b),f.security.uploadRestrictions)?!0:"ALLOW_ALL"==f.security.uploadPolicy&&-1==a.inArray(p(b),f.security.uploadRestrictions)?!0:!1;if(!b)return b="<p>"+e.INVALID_FILE_TYPE+"</p>","DISALLOW_ALL"==f.security.uploadPolicy&&(b+="<p>"+e.ALLOWED_FILE_TYPE+f.security.uploadRestrictions.join(", ")+".</p>"),
"ALLOW_ALL"==f.security.uploadPolicy&&(b+="<p>"+e.DISALLOWED_FILE_TYPE+f.security.uploadRestrictions.join(", ")+".</p>"),a("#filepath").val(""),a.prompt(b),!1;a("#upload").attr("disabled",!0);a("#upload span").addClass("loading").text(e.loading_data);if("images"==a.urlParam("type").toString().toLowerCase()){b=a("#newfile",d).val().toLowerCase().split(".");for(key in f.images.imagesExt)if(f.images.imagesExt[key]==b[b.length-1])return!0;a.prompt(e.UPLOAD_IMAGES_ONLY);a("#upload").removeAttr("disabled").find("span").removeClass("loading").text(e.upload);
return!1}if("undefined"!==typeof FileReader&&"auto"!=typeof f.upload.fileSizeLimit&&a("#newfile",d).get(0).files[0].size>1048576*f.upload.fileSizeLimit)return a.prompt("<p>"+e.file_too_big+"</p><p>"+e.file_size_limit+f.upload.fileSizeLimit+" "+e.mb+".</p>"),a("#upload").removeAttr("disabled").find("span").removeClass("loading").text(e.upload),!1},error:function(){a("#upload").removeAttr("disabled").find("span").removeClass("loading").text(e.upload);a.prompt("Error uploading file")},success:function(){var c=
jQuery.parseJSON(a("#uploadresponse").find("textarea").text());if(0==c.Code){var d=c.Path,b=c.Name,j=p(b),l=a("#filetree").find('a[rel="'+d+'"]'),k=l.parent(),b='<li class="file ext_'+j+'"><a rel="'+d+b+'" href="#" class="">'+b+"</a></li>";k.find("ul").size()?(k.find("ul").prepend(b),l.click().click()):(k=a("#filetree").find("ul.jqueryFileTree"),k.prepend(b),H());h(d);f.options.showConfirmation&&a.prompt(e.successful_added_file);a("#filepath, #newfile").val("");a("#filetree").find('a[rel="'+c.Path+
'/"]').click().click()}else a.prompt(c.Error);a("#upload").removeAttr("disabled");a("#upload span").removeClass("loading").text(e.upload);a("#filepath").val("")}});H();!window.opener&&!window.tinyMCEPopup&&a('#itemOptions a[href$="#select"]').remove();!0==f.options.browseOnly&&(a("#file-input-container").remove(),a("#upload").remove(),a("#newfolder").remove(),a("#toolbar").remove("#rename"),a(".contextMenu .rename").remove(),a(".contextMenu .delete").remove());x(fileRoot+expandedFolder)})})(jQuery);
